<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bibliothèque vidéos</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e9ecf5;
      --muted:#a9b2d3;
      --border:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --accent2:#4ade80;
      --danger:#ff6b6b;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 10% -10%, rgba(122,162,255,.28), transparent 50%),
                  radial-gradient(900px 600px at 90% 0%, rgba(74,222,128,.16), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 48px}
    header{
      display:flex;gap:16px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .title{
      display:flex;flex-direction:column;gap:6px;
    }
    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:999px;
    }
    .pill strong{font-weight:650}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 420px 1fr;}
    }
    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .panel .hd h2{margin:0;font-size:14px;color:var(--muted);font-weight:650;letter-spacing:.2px}
    .panel .bd{padding:14px 16px 16px}
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    input[type="search"]{
      width:min(460px, 100%);
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    select, button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      cursor:pointer;
    }
    button.primary{
      background:rgba(122,162,255,.18);
      border-color:rgba(122,162,255,.35);
    }
    button.primary:hover{background:rgba(122,162,255,.25)}
    button.ghost:hover{background:rgba(255,255,255,.06)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status{
      color:var(--muted);font-size:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent2);display:inline-block}
    .dot.loading{background:var(--accent); animation:pulse 1.1s infinite ease-in-out}
    @keyframes pulse{0%,100%{opacity:.35}50%{opacity:1}}
    .list{
      display:flex;flex-direction:column;gap:10px;
      max-height: 540px;
      overflow:auto;
      padding-right: 6px;
    }
    .item{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius:14px;
      padding:12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .item:hover{background: rgba(0,0,0,.20)}
    .name{font-size:13px;line-height:1.25;word-break:break-word}
    .meta{color:var(--muted);font-size:11px;margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .actions{display:flex;gap:8px;align-items:center;flex-shrink:0}
    .actions a, .actions button{
      padding:8px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      text-decoration:none;
      font-size:12px;
    }
    .actions a:hover, .actions button:hover{background:rgba(255,255,255,.06)}
    .viewer{
      display:flex;flex-direction:column;gap:12px;
    }
    .playerWrap{
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      border-radius: var(--radius);
      overflow:hidden;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .viewerInfo{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .viewerInfo .left{
      display:flex;flex-direction:column;gap:6px;
      min-width:min(520px, 100%);
    }
    .viewerInfo .filename{
      font-weight:700;
      font-size:14px;
      word-break:break-word;
    }
    .viewerInfo .hint{color:var(--muted);font-size:12px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid var(--border);
      border-bottom-color: rgba(255,255,255,.22);
      background:rgba(255,255,255,.04);
      padding:2px 6px;border-radius:8px;
      font-size:11px;color:var(--text);
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(10,16,32,.92);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;color:var(--text);
      display:none;
      max-width:min(720px, calc(100% - 20px));
      text-align:center;
    }
    .empty{
      color:var(--muted);
      font-size:13px;
      padding:18px 0;
      text-align:center;
    }
    .error{
      color:#ffd1d1;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      padding:10px 12px;border-radius:12px;
      font-size:12px;
    }
      .navHome{
      display:inline-block;
      margin-top:12px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#fff;
      text-decoration:none;
      backdrop-filter: blur(8px);
      width: fit-content
    }
    .navHome:hover{
      background:rgba(255,255,255,.10);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Bibliothèque vidéos</h1>
        <a class="navHome" href="/"> <- Accueil </a>
        <div class="subtitle">Liste automatique depuis <span class="kbd">/api/videos</span> • lecture via <span class="kbd">/api/video/…</span></div>
      </div>
      <div class="pill">
        <span class="dot" id="dot"></span>
        <span class="status" id="status">Prêt</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: LIST -->
      <section class="panel">
        <div class="hd">
          <h2>Catalogue</h2>
          <div class="controls">
            <button class="ghost" id="refreshBtn" title="Rafraîchir (R)">Rafraîchir</button>
            <button class="primary" id="loadAllBtn" title="Charger tout (peut être long)">Charger tout</button>
          </div>
        </div>
        <div class="bd">
          <div class="controls" style="margin-bottom:12px">
            <input id="search" type="search" placeholder="Rechercher (nom, dossier, extension…) — ex: onboarding, 2025, .mp4" />
            <select id="sort">
              <option value="name-asc">Tri: A → Z</option>
              <option value="name-desc">Tri: Z → A</option>
            </select>
            <select id="filter">
              <option value="all">Tout</option>
              <option value="mp4">.mp4</option>
              <option value="webm">.webm</option>
              <option value="mov">.mov</option>
              <option value="m4v">.m4v</option>
            </select>
          </div>

          <div id="errorBox" class="error" style="display:none"></div>

          <div class="status" style="margin: 8px 0 12px">
            <span><strong id="countShown">0</strong> affichées</span>
            <span class="tag">Total chargé: <strong id="countLoaded">0</strong></span>
            <span class="tag">Pages: <strong id="countPages">0</strong></span>
            <span class="tag">Raccourcis: <span class="kbd">R</span> rafraîchir • <span class="kbd">/</span> chercher</span>
          </div>

          <div class="list" id="list"></div>

          <div class="controls" style="margin-top:12px; justify-content:space-between">
            <button id="moreBtn" class="ghost">Charger plus</button>
            <div class="status">
              <span class="tag">nextMarker: <strong id="marker">—</strong></span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: VIEWER -->
      <section class="panel">
        <div class="hd">
          <h2>Lecteur</h2>
          <div class="controls">
            <button id="copyBtn" class="ghost" disabled>Copier le lien</button>
            <a id="openBtn" class="ghost" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6">Ouvrir</a>
          </div>
        </div>
        <div class="bd viewer">
          <div class="playerWrap">
            <video id="player" controls playsinline preload="metadata"></video>
          </div>

          <div class="viewerInfo">
            <div class="left">
              <div class="filename" id="filename">Sélectionne une vidéo dans la liste</div>
              <div class="hint">Astuce : clique une vidéo pour la lire. Tu peux aussi ouvrir dans un nouvel onglet.</div>
            </div>
            <div class="status" id="viewerMeta"></div>
          </div>

          <div class="status" style="margin-top:6px">
            <span class="tag">Endpoint liste: <span class="kbd">/api/videos</span></span>
            <span class="tag">Endpoint redirect: <span class="kbd">/api/video/&lt;name&gt;</span></span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      loaded: [],
      nextMarker: null,
      pages: 0,
      loading: false,
      loadedAll: false,
    };

    function setStatus(text, mode = "ready") {
      const dot = $("dot");
      const status = $("status");
      status.textContent = text;

      dot.classList.remove("loading");
      if (mode === "loading") dot.classList.add("loading");
    }

    function showError(msg) {
      const box = $("errorBox");
      if (!msg) {
        box.style.display = "none";
        box.textContent = "";
        return;
      }
      box.style.display = "block";
      box.textContent = msg;
    }

    function toast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(t._to);
      t._to = setTimeout(() => (t.style.display = "none"), 2200);
    }

    function normalizeFilterValue(v) {
      return v.trim().toLowerCase();
    }

    function applyView() {
      const q = normalizeFilterValue($("search").value || "");
      const filter = $("filter").value;
      const sort = $("sort").value;

      let arr = [...state.loaded];

      if (filter !== "all") {
        arr = arr.filter(x => x.name.toLowerCase().endsWith("." + filter));
      }
      if (q) {
        arr = arr.filter(x => x.name.toLowerCase().includes(q));
      }

      arr.sort((a, b) => {
        const cmp = a.name.localeCompare(b.name);
        return sort === "name-desc" ? -cmp : cmp;
      });

      renderList(arr);
      $("countShown").textContent = arr.length;
      $("countLoaded").textContent = state.loaded.length;
      $("countPages").textContent = state.pages;
      $("marker").textContent = state.nextMarker ? "…" : "—";
      $("moreBtn").disabled = !state.nextMarker || state.loading;
    }

    function renderList(items) {
      const list = $("list");
      list.innerHTML = "";

      if (!items.length) {
        const d = document.createElement("div");
        d.className = "empty";
        d.textContent = state.loaded.length ? "Aucun résultat avec ce filtre." : "Aucune vidéo chargée.";
        list.appendChild(d);
        return;
      }

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.style.minWidth = "0";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.name;

        const meta = document.createElement("div");
        meta.className = "meta";

        const ext = it.name.includes(".") ? it.name.split(".").pop().toUpperCase() : "FILE";
        const folder = it.name.includes("/") ? it.name.split("/").slice(0, -1).join("/") : "—";

        meta.innerHTML = `
          <span class="tag">Type: <strong>${ext}</strong></span>
          <span class="tag">Dossier: <strong>${folder}</strong></span>
        `;

        left.appendChild(name);
        left.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "actions";

        const playBtn = document.createElement("button");
        playBtn.textContent = "Lire";
        playBtn.title = "Lire dans le lecteur";
        playBtn.onclick = () => selectVideo(it);

        const openA = document.createElement("a");
        openA.textContent = "Ouvrir";
        openA.href = it.url;
        openA.target = "_blank";
        openA.rel = "noopener";
        openA.title = "Ouvrir dans un nouvel onglet";

        actions.appendChild(playBtn);
        actions.appendChild(openA);

        row.appendChild(left);
        row.appendChild(actions);

        list.appendChild(row);
      }
    }

    function selectVideo(it) {
      const player = $("player");
      player.src = it.url;
      player.play().catch(() => { /* autoplay blocked, ok */ });

      $("filename").textContent = it.name;
      $("viewerMeta").innerHTML = `<span class="tag">Lien: <span class="kbd">${it.url}</span></span>`;

      const openBtn = $("openBtn");
      openBtn.href = it.url;
      openBtn.style.pointerEvents = "auto";
      openBtn.style.opacity = "1";

      const copyBtn = $("copyBtn");
      copyBtn.disabled = false;
      copyBtn.onclick = async () => {
        try {
          const full = new URL(it.url, window.location.origin).toString();
          await navigator.clipboard.writeText(full);
          toast("Lien copié ✅");
        } catch {
          toast("Impossible de copier (permissions navigateur)");
        }
      };
    }

    async function fetchPage(marker = null) {
      const url = marker ? `/api/videos?marker=${encodeURIComponent(marker)}` : "/api/videos";
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} sur ${url}`);
      return r.json();
    }

    async function loadMore() {
      if (state.loading) return;
      state.loading = true;
      showError(null);
      setStatus("Chargement…", "loading");

      try {
        const data = await fetchPage(state.nextMarker);
        const items = Array.isArray(data.items) ? data.items : (data.items?.items ?? []);
        const next = data.nextMarker ?? null;

        state.loaded.push(...items);
        state.nextMarker = next;
        state.pages += 1;

        setStatus("OK");
        applyView();
      } catch (e) {
        setStatus("Erreur");
        showError(`Erreur lors du chargement de la liste: ${e.message}`);
      } finally {
        state.loading = false;
        $("moreBtn").disabled = !state.nextMarker || state.loading;
      }
    }

    async function loadAll() {
      if (state.loading) return;
      showError(null);
      setStatus("Chargement de toutes les pages…", "loading");
      state.loadedAll = false;

      try {
        state.loaded = [];
        state.nextMarker = null;
        state.pages = 0;

        await loadMore();
        while (state.nextMarker) {
          await loadMore();
        }

        state.loadedAll = true;
        setStatus("Tout chargé ✅");
      } catch (e) {
        setStatus("Erreur");
        showError(`Erreur lors du chargement complet: ${e.message}`);
      }
    }

    function resetAndLoadFirst() {
      state.loaded = [];
      state.nextMarker = null;
      state.pages = 0;
      $("player").removeAttribute("src");
      $("player").load();
      $("filename").textContent = "Sélectionne une vidéo dans la liste";
      $("viewerMeta").innerHTML = "";
      $("copyBtn").disabled = true;
      $("openBtn").href = "#";
      $("openBtn").style.pointerEvents = "none";
      $("openBtn").style.opacity = ".6";
      loadMore();
    }

    $("moreBtn").addEventListener("click", loadMore);
    $("loadAllBtn").addEventListener("click", loadAll);
    $("refreshBtn").addEventListener("click", () => {
      resetAndLoadFirst();
      toast("Rafraîchi ✅");
    });

    $("search").addEventListener("input", applyView);
    $("filter").addEventListener("change", applyView);
    $("sort").addEventListener("change", applyView);

    document.addEventListener("keydown", (e) => {
      if (e.key === "r" || e.key === "R") {
        e.preventDefault();
        $("refreshBtn").click();
      }
      if (e.key === "/") {
        e.preventDefault();
        $("search").focus();
      }
    });

    resetAndLoadFirst();
  </script>
</body>
</html>
